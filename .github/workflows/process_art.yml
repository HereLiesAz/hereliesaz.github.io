name: Process Art (Parallel)

on:
  push:
    paths:
      - 'assets/raw/**'
      - 'assets/meta/**'
      - 'assets/pages/**'
  workflow_dispatch:
    inputs:
      shards:
        description: 'Number of parallel runners'
        required: true
        default: '4'

permissions:
  contents: write

jobs:
  # PHASE 1: THE SWARM
  grind:
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        # We define a static list of potential IDs. 
        # If you want 4 runners, we use 0,1,2,3.
        # You can increase this list if you want more power later.
        shard_id: [0, 1, 2, 3] 
    
    steps:
      - name: Checkout Code
        uses: actions/checkout@v3
        with:
          fetch-depth: 0

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.9'

      - name: Install Dependencies
        run: |
          pip install opencv-python numpy torch torchvision Pillow scipy timm huggingface_hub
          pip install git+https://github.com/facebookresearch/segment-anything.git

      - name: Grind Shard ${{ matrix.shard_id }}
        # We pass the matrix ID and the total count (4) to the script
        run: python scripts/grinder.py --input assets/raw --shard ${{ matrix.shard_id }} --total 4

      - name: Upload Artifacts (Data)
        uses: actions/upload-artifact@v4
        with:
          name: shard-${{ matrix.shard_id }}-data
          path: public/data/*.json
          if-no-files-found: ignore

      - name: Upload Artifacts (Meta)
        uses: actions/upload-artifact@v4
        with:
          name: shard-${{ matrix.shard_id }}-meta
          path: assets/meta/*.md
          if-no-files-found: ignore

  # PHASE 2: THE COLLAPSE
  finalize:
    needs: grind
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Code
        uses: actions/checkout@v3
        with:
          fetch-depth: 0

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.9'

      - name: Download All Artifacts
        uses: actions/download-artifact@v4
        with:
          path: temp_artifacts
          merge-multiple: true

      - name: Restore Data
        # Move the downloaded artifacts into the correct folders
        run: |
          mkdir -p public/data
          mkdir -p assets/meta
          
          # Copy JSONs if they exist
          if ls temp_artifacts/*.json 1> /dev/null 2>&1; then
            cp temp_artifacts/*.json public/data/
          fi
          
          # Copy MDs if they exist
          if ls temp_artifacts/*.md 1> /dev/null 2>&1; then
            cp temp_artifacts/*.md assets/meta/
          fi

      - name: Index Everything
        run: python scripts/indexer.py

      - name: Commit & Push
        run: |
          git config --global user.name "ArtGrinder Bot"
          git config --global user.email "bot@hereliesaz.com"
          
          git add public/data/*.json
          git add public/manifest.json
          git add assets/meta/*.md
          git add assets/pages/*.md
          
          git diff --staged --quiet || git commit -m "Parallel Grind Complete (4x Speed)"
          git push
