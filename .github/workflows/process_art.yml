name: Process Art

# 1. TRIGGERS
on:
  push:
    paths:
      - 'assets/raw/**'   # Run when new images are uploaded
      - 'assets/meta/**'  # Run when you edit text in Prose.io
  workflow_dispatch:      # Allows manual run button

# 2. PERMISSIONS (Required to commit changes back)
permissions:
  contents: write

# 3. JOBS
jobs:
  grind-and-index:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Code
        uses: actions/checkout@v3
        with:
          fetch-depth: 0 # Get full history

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.9'

      - name: Install Dependencies
        run: |
          pip install opencv-python numpy torch torchvision Pillow scipy timm huggingface_hub
          pip install git+https://github.com/facebookresearch/segment-anything.git

      - name: Grind Images (Generate Data & Stubs)
        # This will create JSONs in public/data AND .md stubs in assets/meta
        run: python scripts/grinder.py --input assets/raw

      - name: Index Metadata (Build Manifest)
        # This merges the Prose edits into the final app manifest
        run: python scripts/indexer.py

      - name: Commit Changes
        run: |
          git config --global user.name "ArtGrinder Bot"
          git config --global user.email "bot@hereliesaz.com"
          # Add the generated data
          git add public/data/*.json
          git add public/manifest.json
          # Add the metadata stubs (so they show up in Prose)
          git add assets/meta/*.md
          # Only commit if something actually changed
          git diff --staged --quiet || git commit -m "Auto-processed art and metadata"
          git push
